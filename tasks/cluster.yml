---

- name: Change hostname to the FQDN which is used when setting RABBITMQ_USE_LONGNAME (clustering)
  hostname:
    name: "{{ ansible_hostname }}{{ rabbitmq_nodename_suffix }}"

- name: Install python-pip to install python packages (clustering)
  apt:
    name: '{{ item }}'
    state: present
  with_items:
    - python-pip
    # build dependencies to install ansible pip package
    - libyaml-dev
    - python-dev

- name: Install boto & ansible to update clustering on the instance (clustering)
  pip:
    name: '{{ item }}'
    state: latest
  with_items:
    - pip
    - jinja2
    - boto
    - ansible

- name: Set rabbit environment file (clustering)
  template:
    src: rabbitmq-env.conf.j2
    dest: /etc/rabbitmq/rabbitmq-env.conf

- name: ensure cookies are the same between all envs (clustering)
  template:
    src: erlang.cookie.j2
    dest: /var/lib/rabbitmq/.erlang.cookie

- name: Create ansible library dir in root folder
  file:
    path: /root/library
    state: directory

- name: Add ansible ec2_search module to library
  copy:
    src: ec2_search.py
    dest: /root/library/ec2_search.py

- name: Place playbook using this role into /root
  template:
    src: rabbit_bootup.yml.j2
    dest: /root/rabbit_bootup.yml

- name: Add ansible execution to bootup of instance (hooks intance up to cluster)
  lineinfile:
    dest: /etc/rc.local
    insertbefore: 'exit 0'
    line: 'cd /root/ && /usr/local/bin/ansible-playbook rabbit_bootup.yml >> /var/log/rc.local.log 2>&1'

